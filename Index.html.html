<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Retro Booth â€” Scan â€¢ Snap â€¢ Retro</title>
<style>
  :root{--accent:#f1c40f}
  body{font-family:Inter,system-ui,Segoe UI,Arial;margin:0;background:#0b0b0b;color:#fff;display:flex;flex-direction:column;min-height:100vh;align-items:center;justify-content:flex-start;padding:18px}
  header{width:100%;max-width:980px;text-align:center;margin-bottom:10px}
  h1{margin:.25rem 0;font-size:1.1rem}
  .wrap{width:100%;max-width:980px;background:#0f0f0f;padding:12px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,.6)}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
  button, .btn{background:transparent;border:1px solid rgba(255,255,255,.06);padding:8px 12px;border-radius:8px;color:#fff;cursor:pointer}
  input[type=file]{display:none}
  canvas{width:100%;height:auto;border-radius:8px;display:block;max-height:66vh}
  .row{display:flex;gap:12px;align-items:center}
  .small{font-size:.85rem;color:#bbb}
  .download{background:var(--accent);color:#000;border:none}
  .meta{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
  .table-badge{background:#111;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.04)}
  .note{color:#aaa;font-size:.82rem;margin-top:8px}
  .badge{font-weight:600}
  #status{margin-top:8px;padding:8px;border-radius:6px;background:rgba(241,196,15,0.1);color:var(--accent);font-size:.85rem;display:none}
</style>
</head>
<body>
<header>
  <h1>RETRO BOOTH â€” Scan â€¢ Snap â€¢ Download</h1>
  <div class="small">Table: <span id="tableId" class="badge">â€”</span></div>
</header>

<main class="wrap">
  <div class="controls">
    <label class="btn" id="useCameraBtn">Use Camera</label>
    <label class="btn">
      <input id="fileInput" type="file" accept="image/*">
      Upload Photo
    </label>
    <button class="btn" id="resetBtn">Reset</button>
    <button class="btn download" id="downloadBtn">Download Retro Pic</button>
  </div>

  <div class="row">
    <canvas id="canvas"></canvas>
  </div>

  <div id="status"></div>

  <div class="meta">
    <div class="table-badge">Table <span id="tableLocal">â€”</span></div>
    <div class="small">Tip: Dark background gives stronger retro vibe</div>
  </div>

  <div class="note">No files are uploaded anywhere. Everything stays on your phone.</div>
</main>

<script>
(async function(){
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d',{willReadFrequently:true});
  const fileInput = document.getElementById('fileInput');
  const useCameraBtn = document.getElementById('useCameraBtn');
  const resetBtn = document.getElementById('resetBtn');
  const downloadBtn = document.getElementById('downloadBtn');
  const tableIdSpan = document.getElementById('tableId');
  const tableLocal = document.getElementById('tableLocal');
  const status = document.getElementById('status');

  const urlParams = new URLSearchParams(location.search);
  const table = urlParams.get('table') || 'â€”';
  tableIdSpan.textContent = table;
  tableLocal.textContent = table;

  let currentImage = null;
  let cameraStream = null;

  function showStatus(msg){
    status.textContent = msg;
    status.style.display = 'block';
    setTimeout(()=>{ status.style.display = 'none'; }, 2000);
  }

  function fitCanvasTo(img){
    const maxW = Math.min(window.innerWidth - 64, 1200);
    const ratio = img.width / img.height;
    canvas.width = Math.min(img.width, maxW);
    canvas.height = canvas.width / ratio;
  }

  function applyRetro(img){
    fitCanvasTo(img);
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(img,0,0,canvas.width,canvas.height);

    const imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
    const data = imageData.data;
    
    // Retro color grading
    for(let i=0;i<data.length;i+=4){
      let r=data[i], g=data[i+1], b=data[i+2];
      const l = 0.3*r + 0.59*g + 0.11*b;
      data[i]   = r + (l - r)*0.35;
      data[i+1] = g + (l - g)*0.45;
      data[i+2] = b + (l - b)*0.55;
      data[i]   = Math.min(255, data[i] * 0.9 + 20);
      data[i+1] = Math.min(255, data[i+1] * 0.85 + 10);
      data[i+2] = Math.min(255, data[i+2] * 0.7);
      const contrast = 1.08;
      data[i]   = Math.max(0, Math.min(255, (((data[i]-128)*contrast)+128)));
      data[i+1] = Math.max(0, Math.min(255, (((data[i+1]-128)*contrast)+128)));
      data[i+2] = Math.max(0, Math.min(255, (((data[i+2]-128)*contrast)+128)));
    }
    ctx.putImageData(imageData,0,0);
  }

  function loadImageFromFile(file){
    const img = new Image();
    const url = URL.createObjectURL(file);
    img.onload = ()=>{
      currentImage = img;
      applyRetro(img);
      URL.revokeObjectURL(url);
    };
    img.src = url;
  }

  fileInput.addEventListener('change', e=>{
    if(!e.target.files || !e.target.files[0]) return;
    loadImageFromFile(e.target.files[0]);
    fileInput.value = '';
  });

  useCameraBtn.addEventListener('click', async () => {
    if(cameraStream){
      cameraStream.getTracks().forEach(t=>t.stop());
      cameraStream = null;
      useCameraBtn.textContent = 'Use Camera';
      return;
    }

    try{
      cameraStream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'user', width:{ideal:1280}, height:{ideal:720} } });
      const v = document.createElement('video');
      v.autoplay = true;
      v.playsInline = true;
      v.srcObject = cameraStream;
      useCameraBtn.textContent = 'ðŸ“¸ Tap Canvas to Capture';

      const drawLoop = () => {
        if(v.readyState >= 2){
          fitCanvasTo({width:v.videoWidth,height:v.videoHeight});
          ctx.drawImage(v,0,0,canvas.width,canvas.height);
          // Quick retro preview
          const imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
          const data = imageData.data;
          for(let i=0;i<data.length;i+=4){
            data[i] = Math.min(255, data[i]*0.9 + 20);
            data[i+1] = Math.min(255, data[i+1]*0.85 + 10);
            data[i+2] = Math.min(255, data[i+2]*0.7);
          }
          ctx.putImageData(imageData,0,0);
        }
        if(cameraStream && cameraStream.active) requestAnimationFrame(drawLoop);
      };
      drawLoop();

      const captureHandler = () => {
        canvas.toBlob((blob) => {
          const img = new Image();
          const url = URL.createObjectURL(blob);
          img.onload = () => { currentImage = img; applyRetro(img); URL.revokeObjectURL(url); };
          img.src = url;
        }, 'image/jpeg', 0.95);

        cameraStream.getTracks().forEach(t=>t.stop());
        cameraStream = null;
        useCameraBtn.textContent = 'Use Camera';
        canvas.removeEventListener('click', captureHandler);
      };
      canvas.addEventListener('click', captureHandler);

    } catch(err){
      console.error(err);
      alert('Camera not available. Use Upload instead.');
      cameraStream = null;
      useCameraBtn.textContent = 'Use Camera';
    }
  });

  resetBtn.addEventListener('click', ()=>{
    if(cameraStream){
      cameraStream.getTracks().forEach(t=>t.stop());
      cameraStream = null;
      useCameraBtn.textContent = 'Use Camera';
    }
    ctx.clearRect(0,0,canvas.width,canvas.height);
    currentImage = null;
    showPlaceholder();
  });

  downloadBtn.addEventListener('click', ()=>{
    if(!currentImage){ alert('No image yet. Upload or use camera first.'); return; }
    const a = document.createElement('a');
    a.href = canvas.toDataURL('image/jpeg',0.95);
    a.download = `retro-table-${table}-${Date.now()}.jpg`;
    a.click();
    showStatus('ðŸ“¥ Downloaded!');
  });

  function showPlaceholder(){
    const placeholder = document.createElement('canvas');
    placeholder.width=800; placeholder.height=500;
    const pctx = placeholder.getContext('2d');
    pctx.fillStyle = '#222'; pctx.fillRect(0,0,800,500);
    pctx.fillStyle='#888'; pctx.font='36px sans-serif'; pctx.textAlign='center';
    pctx.fillText('Upload or use camera', 400, 260);
    const img = new Image();
    img.onload = ()=>{ fitCanvasTo(img); ctx.drawImage(img,0,0,canvas.width,canvas.height); };
    img.src = placeholder.toDataURL();
  }

  showPlaceholder();
})();
</script>
</body>
</html>
